<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园刷题宝 - 在线刷题</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/exam.css">
    <style>
        /* 新增错题弹窗样式 */
        .error-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .error-modal-content {
            background: white;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .error-title {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
        }
        .close-modal {
            background: #eee;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        }
        .error-list {
            margin-bottom: 20px;
        }
        .error-item {
            padding: 10px;
            border: 1px solid #f8d7da;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .error-item:hover {
            background: #f8f9fa;
        }
        .error-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .error-item-answer {
            font-size: 14px;
            color: #666;
        }
        .your-answer {
            color: #e74c3c;
        }
        .correct-answer {
            color: #27ae60;
        }
        .error-detail {
            display: none;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 10px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-review {
            background: #3498db;
            color: white;
        }
        .btn-back {
            background: #95a5a6;
            color: white;
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="container">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>校园刷题宝</h1>
            </div>
            <nav class="nav-links">
                <a href="../index.html">首页</a>
                <a href="student.html">学生中心</a>
                <a href="exam.html" class="active">在线刷题</a>
                <a href="#" id="logoutBtn">退出登录</a>
            </nav>
            <button class="menu-btn"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <section class="exam-wrapper">
        <div class="exam-container">
            <div class="exam-header">
                <h2 class="exam-title">高三英语3+2期末选择1</h2>
                <div class="exam-meta">
                    <span><i class="fas fa-question-circle"></i> 共<span id="total-questions">90</span>题</span>
                    <span><i class="fas fa-clock"></i> 剩余时间：<span id="countdown">100:00</span></span>
                    <span><i class="fas fa-list-ol"></i> 当前第<span id="current-question-num">1</span>题</span>
                </div>
            </div>

            <div class="exam-body">
                <div class="question-box">
                    <h3 class="question-title" id="question-title">加载中...</h3>
                    <div class="option-list" id="option-list">
                        <!-- 动态生成选项 -->
                    </div>
                </div>
            </div>

            <div class="exam-footer">
                <button class="exam-btn btn-prev" id="prev-btn" disabled>上一题</button>
                <div>
                    <button class="exam-btn btn-next" id="next-btn">下一题</button>
                    <button class="exam-btn btn-submit" id="submit-btn">提交试卷</button>
                </div>
            </div>
        </div>
    </section>

    <!-- 新增错题弹窗 -->
    <div class="error-modal" id="errorModal">
        <div class="error-modal-content">
            <div class="error-header">
                <div class="error-title">错题回顾（共<span id="error-count">0</span>题）</div>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="error-list" id="errorList">
                <!-- 动态生成错题列表 -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-review" id="reviewBtn">重新答题</button>
                <button class="modal-btn btn-back" id="backBtn">返回学生中心</button>
            </div>
        </div>
    </div>

    <script src="../js/common.js"></script>
    <script>
        // 全局变量
        let questionBank = []; // 存储打乱后的题库
        let originalQuestionBank = []; // 保存原始题库（用于重新答题）
        let currentIndex = 0;  // 当前题目索引
        let userAnswers = {};  // 存储用户答案 {题id: 选项}
        let countdownTimer = null; // 倒计时定时器
        let errorQuestions = []; // 存储错题列表

        // DOM 元素
        const questionTitle = document.getElementById('question-title');
        const optionList = document.getElementById('option-list');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const currentQuestionNum = document.getElementById('current-question-num');
        const totalQuestions = document.getElementById('total-questions');
        const countdown = document.getElementById('countdown');
        // 错题弹窗元素
        const errorModal = document.getElementById('errorModal');
        const errorList = document.getElementById('errorList');
        const errorCount = document.getElementById('error-count');
        const closeModal = document.getElementById('closeModal');
        const reviewBtn = document.getElementById('reviewBtn');
        const backBtn = document.getElementById('backBtn');

        // 1. 初始化：加载题库 + 打乱题目 + 启动倒计时
        async function initExam() {
            try {
                // 加载JSON题库
                const response = await fetch('/data/questionBank.json');
                if (!response.ok) throw new Error('题库加载失败');
                const data = await response.json();
                
                // 保存原始题库（用于重新答题）
                originalQuestionBank = [...data.questions];
                // 打乱题目顺序
                questionBank = shuffleArray([...originalQuestionBank]);
                // 对每道题打乱选项顺序，并适配正确答案
                questionBank = questionBank.map(question => shuffleQuestionOptions(question));
                
                totalQuestions.textContent = questionBank.length;
                // 渲染第一题
                renderQuestion(currentIndex);
                // 启动倒计时
                startCountdown();
            } catch (error) {
                questionTitle.textContent = '题库加载失败，请刷新页面！';
                console.error('题库加载错误：', error);
            }
        }

        // 2. 渲染当前题目
        function renderQuestion(index) {
            if (questionBank.length === 0) return;
            
            const question = questionBank[index];
            // 更新题目标题
            questionTitle.textContent = `${index + 1}. ${question.title.replace(/^\d+\./, '')}`;
            // 更新当前题数
            currentQuestionNum.textContent = index + 1;
            // 清空选项列表
            optionList.innerHTML = '';
            
            // 动态生成选项
            question.options.forEach((opt, i) => {
                const optionChar = String.fromCharCode(65 + i); // A/B/C/D
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.innerHTML = `
                    <input type="radio" name="answer" id="opt${optionChar}" value="${optionChar}">
                    <label for="opt${optionChar}">${optionChar}. ${opt}</label>
                `;
                optionList.appendChild(optionItem);

                // 回显用户已选答案
                if (userAnswers[question.id] === optionChar) {
                    document.getElementById(`opt${optionChar}`).checked = true;
                }
            });

            // 禁用/启用上一题/下一题按钮
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === questionBank.length - 1;
        }

        // 3. 保存当前题答案
        function saveCurrentAnswer() {
            const question = questionBank[currentIndex];
            const selectedOption = document.querySelector('input[name="answer"]:checked');
            if (selectedOption) {
                userAnswers[question.id] = selectedOption.value;
            }
        }

        // 4. 上一题按钮事件
        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                saveCurrentAnswer();
                currentIndex--;
                renderQuestion(currentIndex);
            }
        });

        // 5. 下一题按钮事件
        nextBtn.addEventListener('click', () => {
            if (currentIndex < questionBank.length - 1) {
                saveCurrentAnswer();
                currentIndex++;
                renderQuestion(currentIndex);
            }
        });

        // 6. 提交试卷事件
        submitBtn.addEventListener('click', () => {
            if (questionBank.length === 0) return;
            
            // 保存最后一题答案
            saveCurrentAnswer();
            
            // 计算得分 + 收集错题
            let correctCount = 0;
            errorQuestions = [];
            
            questionBank.forEach(question => {
                const userAns = userAnswers[question.id];
                if (userAns === question.answer) {
                    correctCount++;
                } else {
                    // 收集错题（包含题目信息、用户答案、正确答案）
                    errorQuestions.push({
                        id: question.id,
                        title: question.title,
                        options: question.options,
                        yourAnswer: userAns || '未作答',
                        correctAnswer: question.answer,
                        correctContent: question.options[question.answer.charCodeAt(0) - 65]
                    });
                }
            });
            
            const score = (correctCount / questionBank.length) * 100;

            // 停止倒计时
            clearInterval(countdownTimer);
            
            // 显示错题弹窗
            showErrorModal(score, correctCount);
        });

        // 7. 显示错题弹窗
        function showErrorModal(score, correctCount) {
            // 更新错题数量
            errorCount.textContent = errorQuestions.length;
            
            // 清空错题列表
            errorList.innerHTML = '';
            
            // 生成错题列表
            errorQuestions.forEach((error, index) => {
                const errorItem = document.createElement('div');
                errorItem.className = 'error-item';
                
                // 错题标题 + 答案对比
                errorItem.innerHTML = `
                    <div class="error-item-title">${index + 1}. ${error.title.replace(/^\d+\./, '')}</div>
                    <div class="error-item-answer">
                        你的答案：<span class="your-answer">${error.yourAnswer}</span> | 
                        正确答案：<span class="correct-answer">${error.correctAnswer}（${error.correctContent}）</span>
                    </div>
                    <!-- 错题详情（点击展开） -->
                    <div class="error-detail" id="detail-${error.id}">
                        <div style="font-weight: 600; margin-bottom: 5px;">题目详情：</div>
                        ${error.options.map((opt, i) => {
                            const char = String.fromCharCode(65 + i);
                            // 正确答案标绿，用户错误答案标红
                            let color = '';
                            if (char === error.correctAnswer) color = 'color: #27ae60;';
                            else if (char === error.yourAnswer) color = 'color: #e74c3c;';
                            
                            return `<div style="${color}">${char}. ${opt}</div>`;
                        }).join('')}
                    </div>
                `;
                
                // 点击错题展开/收起详情
                errorItem.addEventListener('click', () => {
                    const detail = document.getElementById(`detail-${error.id}`);
                    detail.style.display = detail.style.display === 'block' ? 'none' : 'block';
                });
                
                errorList.appendChild(errorItem);
            });
            
            // 显示弹窗
            errorModal.style.display = 'flex';
        }

        // 8. 重新答题按钮事件
        reviewBtn.addEventListener('click', () => {
            // 关闭弹窗
            errorModal.style.display = 'none';
            
            // 重置状态
            currentIndex = 0;
            userAnswers = {};
            errorQuestions = [];
            
            // 重新打乱题目和选项
            questionBank = shuffleArray([...originalQuestionBank]);
            questionBank = questionBank.map(question => shuffleQuestionOptions(question));
            
            // 重新渲染第一题
            renderQuestion(currentIndex);
            
            // 重启倒计时
            startCountdown();
        });

        // 9. 返回学生中心按钮事件
        backBtn.addEventListener('click', () => {
            window.location.href = 'student.html';
        });

        // 10. 关闭弹窗按钮事件
        closeModal.addEventListener('click', () => {
            errorModal.style.display = 'none';
        });

        // 11. 点击弹窗外层关闭
        window.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                errorModal.style.display = 'none';
            }
        });

        // 12. 工具函数：Fisher-Yates 洗牌算法（打乱数组）
        function shuffleArray(arr) {
            const newArr = [...arr];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }

        // 13. 工具函数：打乱单题选项，并适配正确答案
        function shuffleQuestionOptions(question) {
            // 保存选项和原字母的映射
            const optionWithChar = question.options.map((opt, i) => ({
                char: String.fromCharCode(65 + i), // 原字母 A/B/C/D
                content: opt
            }));
            
            // 打乱选项顺序
            const shuffledOptions = shuffleArray(optionWithChar);
            
            // 重新生成选项列表（只保留内容）
            const newOptions = shuffledOptions.map(item => item.content);
            
            // 找到新的正确答案字母
            let newAnswer = '';
            const originalCorrectContent = question.options[question.answer.charCodeAt(0) - 65];
            shuffledOptions.forEach(item => {
                if (item.content === originalCorrectContent) {
                    newAnswer = String.fromCharCode(65 + shuffledOptions.indexOf(item));
                }
            });

            return {
                ...question,
                options: newOptions,
                answer: newAnswer
            };
        }

        // 14. 倒计时功能
        function startCountdown() {
            let minutes = 100;
            let seconds = 0;
            
            // 重置倒计时显示
            countdown.textContent = `${minutes.toString().padStart(2, '0')}:00`;
            
            countdownTimer = setInterval(() => {
                // 秒数减1
                seconds--;
                if (seconds < 0) {
                    minutes--;
                    seconds = 59;
                }
                
                // 格式化为 MM:SS
                const formattedMin = minutes.toString().padStart(2, '0');
                const formattedSec = seconds.toString().padStart(2, '0');
                countdown.textContent = `${formattedMin}:${formattedSec}`;
                
                // 倒计时结束
                if (minutes === 0 && seconds === 0) {
                    clearInterval(countdownTimer);
                    alert('时间到！自动提交试卷');
                    submitBtn.click();
                }
            }, 1000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initExam);

        // 页面关闭时清除定时器
        window.addEventListener('beforeunload', () => {
            clearInterval(countdownTimer);
        });
    </script>
</body>
</html>